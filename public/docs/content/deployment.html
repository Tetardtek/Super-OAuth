<h2>ğŸš€ Guide de DÃ©ploiement SuperOAuth</h2>

<div class="deployment-overview">
    <p>Ce guide vous accompagne pas Ã  pas dans le dÃ©ploiement de SuperOAuth en production avec toutes les bonnes pratiques de sÃ©curitÃ© et de performance.</p>
</div>

<div class="deployment-status">
    <div class="status-progress">
        <div class="progress-step completed">
            <span class="step-icon">ğŸ’»</span>
            <span>Serveur</span>
        </div>
        <div class="progress-step">
            <span class="step-icon">ğŸ› ï¸</span>
            <span>Installation</span>
        </div>
        <div class="progress-step">
            <span class="step-icon">ğŸ“¦</span>
            <span>Application</span>
        </div>
        <div class="progress-step">
            <span class="step-icon">ğŸŒ</span>
            <span>Nginx</span>
        </div>
        <div class="progress-step">
            <span class="step-icon">ğŸ”’</span>
            <span>SSL</span>
        </div>
        <div class="progress-step">
            <span class="step-icon">âœ…</span>
            <span>Tests</span>
        </div>
    </div>
</div>

<h3>ğŸ“‹ PrÃ©requis</h3>

<div class="requirements-grid">
    <div class="requirement-card">
        <h4>ğŸ–¥ï¸ Serveur de Production</h4>
        <ul>
            <li><strong>OS</strong> : Ubuntu 20.04+ ou CentOS 8+</li>
            <li><strong>RAM</strong> : Minimum 2GB, recommandÃ© 4GB+</li>
            <li><strong>CPU</strong> : 2 vCPU minimum</li>
            <li><strong>Stockage</strong> : 20GB SSD minimum</li>
            <li><strong>RÃ©seau</strong> : AccÃ¨s HTTPS (port 443)</li>
        </ul>
    </div>
    
    <div class="requirement-card">
        <h4>ğŸ› ï¸ Logiciels Requis</h4>
        <ul>
            <li><strong>Node.js</strong> 18+ LTS</li>
            <li><strong>MySQL</strong> 8.0+</li>
            <li><strong>Nginx</strong> (proxy inverse)</li>
            <li><strong>PM2</strong> (gestionnaire de processus)</li>
            <li><strong>Certbot</strong> (certificats SSL)</li>
        </ul>
    </div>
</div>

<h3>ğŸ› ï¸ PrÃ©paration du Serveur</h3>

<div class="deployment-section">
    <h4>1ï¸âƒ£ Mise Ã  jour du SystÃ¨me</h4>
    <div class="code-block"># Ubuntu/Debian
sudo apt update && sudo apt upgrade -y

# CentOS/RHEL
sudo yum update -y</div>
</div>

<div class="deployment-section">
    <h4>2ï¸âƒ£ Installation de Node.js</h4>
    <div class="code-block"># Via NodeSource
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# VÃ©rification
node --version
npm --version</div>
</div>

<div class="deployment-section">
    <h4>3ï¸âƒ£ Installation et Configuration MySQL</h4>
    <div class="code-block"># Installation
sudo apt install mysql-server

# Configuration sÃ©curisÃ©e
sudo mysql_secure_installation

# CrÃ©ation de la base de donnÃ©es
sudo mysql -u root -p</div>
    
    <div class="code-block"># Commandes SQL
CREATE DATABASE superoauth;
CREATE USER 'superoauth_user'@'localhost' IDENTIFIED BY 'your_secure_password';
GRANT ALL PRIVILEGES ON superoauth.* TO 'superoauth_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;</div>
</div>

<div class="deployment-section">
    <h4>4ï¸âƒ£ Installation de Nginx et PM2</h4>
    <div class="code-block"># Nginx
sudo apt install nginx
sudo systemctl enable nginx
sudo systemctl start nginx

# PM2
sudo npm install -g pm2</div>
</div>

<h3>ğŸ“¦ DÃ©ploiement de l'Application</h3>

<div class="deployment-section">
    <h4>1ï¸âƒ£ Clonage et PrÃ©paration</h4>
    <div class="code-block"># CrÃ©ation du rÃ©pertoire
sudo mkdir -p /var/www/superoauth
sudo chown $USER:$USER /var/www/superoauth

# Clonage
cd /var/www/superoauth
git clone &lt;your-repository-url&gt; .

# Installation des dÃ©pendances
npm ci --only=production</div>
</div>

<div class="deployment-section">
    <h4>2ï¸âƒ£ Configuration de Production</h4>
    <div class="env-config">
        <h5>ğŸ”§ Variables d'Environnement</h5>
        <div class="code-block"># CrÃ©ation du fichier .env
cat > .env << EOF
NODE_ENV=production
PORT=3000

# Base de donnÃ©es
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=superoauth_user
DB_PASSWORD=your_secure_password
DB_DATABASE=superoauth

# JWT Secrets (gÃ©nÃ©rer avec openssl rand -base64 32)
JWT_SECRET=your_256_bit_secret_key_here
JWT_REFRESH_SECRET=your_different_256_bit_refresh_key

# OAuth Configuration
DISCORD_CLIENT_ID=your_discord_client_id
DISCORD_CLIENT_SECRET=your_discord_client_secret
DISCORD_REDIRECT_URI=https://yourdomain.com/api/v1/auth/oauth/discord/callback
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret
GOOGLE_REDIRECT_URI=https://yourdomain.com/api/v1/auth/oauth/google/callback

# Whitelist dynamique des redirect_uri OAuth (multi-environnements)
# Ajoutez ici toutes les URLs de callback autorisÃ©es pour chaque provider, sÃ©parÃ©es par des virgules
REDIRECT_URIS_DISCORD=https://yourdomain.com/api/v1/auth/oauth/discord/callback,https://localhost:3000/auth/discord/callback
REDIRECT_URIS_GOOGLE=https://yourdomain.com/api/v1/auth/oauth/google/callback,https://localhost:3000/auth/google/callback
REDIRECT_URIS_TWITCH=https://yourdomain.com/api/v1/auth/oauth/twitch/callback,https://localhost:3000/auth/twitch/callback
REDIRECT_URIS_GITHUB=https://yourdomain.com/api/v1/auth/oauth/github/callback,https://localhost:3000/auth/github/callback

# SÃ©curitÃ©
CORS_ORIGIN=https://yourdomain.com
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX=100
EOF

# SÃ©curiser le fichier
chmod 600 .env</div>
        <div class="doc-note info" style="margin-top:12px;">
            <strong>â„¹ï¸ Astuce :</strong> Pour chaque environnement (dev, staging, prod), ajoutez toutes les URLs de callback nÃ©cessaires dans la variable REDIRECT_URIS_{PROVIDER}.<br>
            <strong>Exemple :</strong> <code>REDIRECT_URIS_DISCORD=https://prod.monsite.com/auth/discord/callback,https://localhost:3000/auth/discord/callback</code><br>
            Ces URLs doivent aussi Ãªtre enregistrÃ©es dans le dashboard du provider OAuth.
        </div>
    </div>
</div>

<div class="deployment-section">
    <h4>3ï¸âƒ£ Build et Migration</h4>
    <div class="code-block"># Compilation TypeScript
npm run build

# Migration de la base de donnÃ©es
npm run migration:run</div>
</div>

<div class="deployment-section">
    <h4>4ï¸âƒ£ Configuration PM2</h4>
    <div class="code-block"># CrÃ©ation du fichier ecosystem
cat > ecosystem.config.js << EOF
module.exports = {
  apps: [{
    name: 'superoauth',
    script: 'dist/index.js',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    log_file: '/var/log/superoauth/combined.log',
    out_file: '/var/log/superoauth/out.log',
    error_file: '/var/log/superoauth/error.log',
    time: true,
    max_memory_restart: '1G',
    node_args: '--max-old-space-size=1024'
  }]
};
EOF

# CrÃ©ation du rÃ©pertoire de logs
sudo mkdir -p /var/log/superoauth
sudo chown $USER:$USER /var/log/superoauth

# DÃ©marrage avec PM2
pm2 start ecosystem.config.js
pm2 save
pm2 startup</div>
</div>

<h3>ğŸŒ Configuration Nginx</h3>

<div class="deployment-section">
    <h4>ğŸ”§ Configuration du Site</h4>
    <div class="code-block">sudo tee /etc/nginx/sites-available/superoauth << EOF
server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;
    
    # Redirection HTTPS
    return 301 https://\$server_name\$request_uri;
}

server {
    listen 443 ssl http2;
    server_name yourdomain.com www.yourdomain.com;

    # Certificats SSL (Certbot les configurera)
    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;
    
    # Configuration SSL sÃ©curisÃ©e
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # Headers de sÃ©curitÃ©
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options DENY;
    add_header X-XSS-Protection "1; mode=block";
    add_header Referrer-Policy "strict-origin-when-cross-origin";

    # Fichiers statiques
    location /public {
        alias /var/www/superoauth/public;
        expires 1y;
        add_header Cache-Control "public, no-transform";
        
        # Gzip pour les fichiers statiques
        gzip on;
        gzip_types text/css application/javascript text/javascript;
    }

    # API et application
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_cache_bypass \$http_upgrade;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Limite la taille des uploads
    client_max_body_size 10M;
    
    # Logs
    access_log /var/log/nginx/superoauth_access.log;
    error_log /var/log/nginx/superoauth_error.log;
}
EOF

# Activation du site
sudo ln -s /etc/nginx/sites-available/superoauth /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx</div>
</div>

<h3>ğŸ”’ Certificats SSL avec Let's Encrypt</h3>

<div class="ssl-section">
    <div class="ssl-step">
        <h4>1ï¸âƒ£ Installation de Certbot</h4>
        <div class="code-block">sudo apt install certbot python3-certbot-nginx</div>
    </div>
    
    <div class="ssl-step">
        <h4>2ï¸âƒ£ Obtention des Certificats</h4>
        <div class="code-block"># ArrÃªt temporaire de Nginx
sudo systemctl stop nginx

# Obtention du certificat
sudo certbot certonly --standalone -d yourdomain.com -d www.yourdomain.com

# RedÃ©marrage de Nginx
sudo systemctl start nginx</div>
    </div>
    
    <div class="ssl-step">
        <h4>3ï¸âƒ£ Renouvellement Automatique</h4>
        <div class="code-block"># Test du renouvellement
sudo certbot renew --dry-run

# Configuration du cron job
sudo crontab -e
# Ajouter : 0 12 * * * /usr/bin/certbot renew --quiet</div>
    </div>
</div>

<h3>ğŸ”¥ Configuration du Firewall</h3>

<div class="firewall-section">
    <div class="firewall-config">
        <h4>ğŸ›¡ï¸ UFW (Ubuntu)</h4>
        <div class="code-block"># Activation
sudo ufw enable

# RÃ¨gles essentielles
sudo ufw allow ssh
sudo ufw allow 'Nginx Full'
sudo ufw allow 3306 # MySQL (si base distante)

# VÃ©rification
sudo ufw status</div>
    </div>
    
    <div class="firewall-config">
        <h4>ğŸš« Fail2Ban (Protection contre les attaques)</h4>
        <div class="code-block"># Installation
sudo apt install fail2ban

# Configuration
sudo tee /etc/fail2ban/jail.local << EOF
[DEFAULT]
bantime = 1h
findtime = 10m
maxretry = 5

[sshd]
enabled = true

[nginx-http-auth]
enabled = true

[nginx-limit-req]
enabled = true
EOF

sudo systemctl enable fail2ban
sudo systemctl start fail2ban</div>
    </div>
</div>

<h3>ğŸ“Š Monitoring et Logs</h3>

<div class="monitoring-section">
    <h4>ğŸ“ Configuration des Logs</h4>
    <div class="code-block"># Rotation des logs avec logrotate
sudo tee /etc/logrotate.d/superoauth << EOF
/var/log/superoauth/*.log {
    daily
    missingok
    rotate 52
    compress
    delaycompress
    notifempty
    create 644 $USER $USER
    postrotate
        pm2 reloadLogs
    endscript
}
EOF</div>

    <h4>ğŸ“ˆ Commandes de Monitoring</h4>
    <div class="monitoring-commands">
        <div class="command-card">
            <h5>PM2 Monitoring</h5>
            <div class="code-block"># Monitoring en temps rÃ©el
pm2 monit

# Logs en temps rÃ©el
pm2 logs superoauth

# Statut des processus
pm2 status</div>
        </div>
        
        <div class="command-card">
            <h5>SystÃ¨me</h5>
            <div class="code-block"># Installation des outils
sudo apt install htop iotop mytop

# Monitoring MySQL
mytop

# Surveillance systÃ¨me
htop</div>
        </div>
    </div>
</div>

<h3>ğŸš€ DÃ©ploiement AutomatisÃ©</h3>

<div class="automation-section">
    <h4>ğŸ“œ Script de DÃ©ploiement</h4>
    <div class="code-block">#!/bin/bash
# deploy.sh

set -e

echo "ğŸš€ DÃ©ploiement SuperOAuth..."

# Variables
APP_DIR="/var/www/superoauth"
BACKUP_DIR="/var/backups/superoauth"

# Sauvegarde
echo "ğŸ“¦ CrÃ©ation de la sauvegarde..."
sudo mkdir -p $BACKUP_DIR
sudo mysqldump -u superoauth_user -p superoauth > $BACKUP_DIR/db_$(date +%Y%m%d_%H%M%S).sql

# Mise Ã  jour du code
echo "ğŸ“¥ Mise Ã  jour du code..."
cd $APP_DIR
git pull origin main

# Installation des dÃ©pendances
echo "ğŸ“¦ Installation des dÃ©pendances..."
npm ci --only=production

# Build
echo "ğŸ”¨ Build de l'application..."
npm run build

# Migration base de donnÃ©es
echo "ğŸ—„ï¸ Migration base de donnÃ©es..."
npm run migration:run

# RedÃ©marrage de l'application
echo "ğŸ”„ RedÃ©marrage de l'application..."
pm2 reload superoauth

# Test de santÃ©
echo "ğŸ¥ Test de santÃ©..."
sleep 5
curl -f http://localhost:3000/health || (echo "âŒ Ã‰chec du test de santÃ©" && exit 1)

echo "âœ… DÃ©ploiement terminÃ© avec succÃ¨s !"</div>

    <div class="script-usage">
        <h5>ğŸ¯ Utilisation du Script</h5>
        <div class="code-block"># Rendre le script exÃ©cutable
chmod +x deploy.sh

# Lancer le dÃ©ploiement
./deploy.sh</div>
    </div>
</div>

<h3>âœ… Checklist de DÃ©ploiement</h3>

<div class="checklist-section">
    <div class="checklist-column">
        <h4>ğŸ”§ Avant le DÃ©ploiement</h4>
        <div class="checklist-items">
            <label class="checklist-item">
                <input type="checkbox"> Serveur configurÃ© et sÃ©curisÃ©
            </label>
            <label class="checklist-item">
                <input type="checkbox"> Base de donnÃ©es crÃ©Ã©e
            </label>
            <label class="checklist-item">
                <input type="checkbox"> Variables d'environnement configurÃ©es
            </label>
            <label class="checklist-item">
                <input type="checkbox"> Certificats SSL obtenus
            </label>
            <label class="checklist-item">
                <input type="checkbox"> Firewall configurÃ©
            </label>
        </div>
    </div>
    
    <div class="checklist-column">
        <h4>âš¡ Pendant le DÃ©ploiement</h4>
        <div class="checklist-items">
            <label class="checklist-item">
                <input type="checkbox"> Code compilÃ© sans erreur
            </label>
            <label class="checklist-item">
                <input type="checkbox"> Migrations de base exÃ©cutÃ©es
            </label>
            <label class="checklist-item">
                <input type="checkbox"> Application dÃ©marrÃ©e avec PM2
            </label>
            <label class="checklist-item">
                <input type="checkbox"> Nginx configurÃ© et redÃ©marrÃ©
            </label>
            <label class="checklist-item">
                <input type="checkbox"> Tests de santÃ© passÃ©s
            </label>
        </div>
    </div>
    
    <div class="checklist-column">
        <h4>ğŸ¯ AprÃ¨s le DÃ©ploiement</h4>
        <div class="checklist-items">
            <label class="checklist-item">
                <input type="checkbox"> Monitoring activÃ©
            </label>
            <label class="checklist-item">
                <input type="checkbox"> Logs configurÃ©s
            </label>
            <label class="checklist-item">
                <input type="checkbox"> Sauvegardes programmÃ©es
            </label>
            <label class="checklist-item">
                <input type="checkbox"> Tests fonctionnels validÃ©s
            </label>
            <label class="checklist-item">
                <input type="checkbox"> Performance vÃ©rifiÃ©e
            </label>
        </div>
    </div>
</div>

<h3>ğŸ†˜ DÃ©pannage</h3>

<div class="troubleshooting-section">
    <div class="problem-card">
        <h4>âš ï¸ Application ne dÃ©marre pas</h4>
        <div class="code-block"># VÃ©rifier les logs
pm2 logs superoauth

# VÃ©rifier la configuration
npm run check:config

# Tester la connexion DB
npm run test:db</div>
    </div>
    
    <div class="problem-card">
        <h4>âš ï¸ Nginx 502 Bad Gateway</h4>
        <div class="code-block"># VÃ©rifier que l'app tourne
pm2 status

# VÃ©rifier les logs Nginx
sudo tail -f /var/log/nginx/error.log

# Tester la connectivitÃ©
curl http://localhost:3000/health</div>
    </div>
    
    <div class="problem-card">
        <h4>âš ï¸ ProblÃ¨mes SSL</h4>
        <div class="code-block"># VÃ©rifier les certificats
sudo certbot certificates

# Tester la configuration SSL
openssl s_client -connect yourdomain.com:443</div>
    </div>
</div>

<div class="deployment-summary">
    <h4>ğŸ¯ RÃ©sumÃ© du DÃ©ploiement</h4>
    <p>Ce guide fournit une approche complÃ¨te et sÃ©curisÃ©e pour dÃ©ployer SuperOAuth en production. Suivez chaque Ã©tape mÃ©thodiquement et n'hÃ©sitez pas Ã  tester en environnement de staging avant la production finale.</p>
    
    <div class="summary-metrics">
        <div class="metric">
            <span class="metric-value">~30min</span>
            <span class="metric-label">Temps d'installation</span>
        </div>
        <div class="metric">
            <span class="metric-value">SSL A+</span>
            <span class="metric-label">Note sÃ©curitÃ©</span>
        </div>
        <div class="metric">
            <span class="metric-value">99.9%</span>
            <span class="metric-label">Uptime cible</span>
        </div>
    </div>
</div>
